name: 'Export Docker Images'
description: 'Export Docker images to tar files for offline deployment'
author: 'Synergia Team'

inputs:
  version:
    description: 'Version of images to export'
    required: true
  output-dir:
    description: 'Output directory for tar files'
    required: false
    default: 'release/images'
  include-mysql:
    description: 'Include MySQL 8.0 image'
    required: false
    default: 'true'
  include-nginx:
    description: 'Include Nginx Alpine image'
    required: false
    default: 'true'

outputs:
  frontend-tar:
    description: 'Path to frontend tar file'
    value: ${{ inputs.output-dir }}/frontend.tar
  backend-tar:
    description: 'Path to backend tar file'
    value: ${{ inputs.output-dir }}/backend.tar
  mysql-tar:
    description: 'Path to MySQL tar file'
    value: ${{ inputs.output-dir }}/mysql.tar
  nginx-tar:
    description: 'Path to Nginx tar file'
    value: ${{ inputs.output-dir }}/nginx.tar

runs:
  using: 'composite'
  steps:
    - name: Create output directory
      shell: bash
      run: |
        echo "ğŸ“ Creating output directory..."
        mkdir -p ${{ inputs.output-dir }}
    
    - name: Pull external images
      shell: bash
      run: |
        echo "ğŸ“¥ Pulling external images..."
        if [ "${{ inputs.include-mysql }}" == "true" ]; then
          echo "  â€¢ Pulling MySQL 8.0..."
          docker pull mysql:8.0
        fi
        if [ "${{ inputs.include-nginx }}" == "true" ]; then
          echo "  â€¢ Pulling Nginx Alpine..."
          docker pull nginx:alpine
        fi
        echo "âœ… External images pulled"
    
    - name: Export Synergia images
      shell: bash
      run: |
        echo "ğŸ’¾ Exporting Synergia images..."
        
        echo "  â€¢ Exporting frontend..."
        docker save synergia-frontend:${{ inputs.version }} \
          -o ${{ inputs.output-dir }}/frontend.tar
        
        echo "  â€¢ Exporting backend..."
        docker save synergia-backend:${{ inputs.version }} \
          -o ${{ inputs.output-dir }}/backend.tar
        
        echo "âœ… Synergia images exported"
    
    - name: Export external images
      shell: bash
      run: |
        echo "ğŸ’¾ Exporting external images..."
        
        if [ "${{ inputs.include-mysql }}" == "true" ]; then
          echo "  â€¢ Exporting MySQL..."
          docker save mysql:8.0 -o ${{ inputs.output-dir }}/mysql.tar
        fi
        
        if [ "${{ inputs.include-nginx }}" == "true" ]; then
          echo "  â€¢ Exporting Nginx..."
          docker save nginx:alpine -o ${{ inputs.output-dir }}/nginx.tar
        fi
        
        echo "âœ… External images exported"
    
    - name: Display export summary
      shell: bash
      run: |
        echo ""
        echo "ğŸ“¦ Exported images summary:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        ls -lh ${{ inputs.output-dir }}/ | tail -n +2
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        TOTAL_SIZE=$(du -sh ${{ inputs.output-dir }} | cut -f1)
        echo "Total size: $TOTAL_SIZE"
