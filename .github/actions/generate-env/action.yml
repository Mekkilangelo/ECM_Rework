name: 'Generate Environment File'
description: 'Generate .env file from GitHub secrets'
author: 'Synergia Team'

inputs:
  environment:
    description: 'Environment type (development/production)'
    required: true
  output-file:
    description: 'Output file path'
    required: true
  mysql-root-password:
    description: 'MySQL root password'
    required: true
  mysql-database:
    description: 'MySQL database name'
    required: true
  db-host:
    description: 'Database host'
    required: true
  db-user:
    description: 'Database user'
    required: true
  db-password:
    description: 'Database password'
    required: true
  db-sync-alter:
    description: 'Database sync alter flag'
    required: false
    default: 'false'
  jwt-secret:
    description: 'JWT secret key'
    required: true
  jwt-expire:
    description: 'JWT expiration time'
    required: false
    default: '24h'
  jwt-inactivity-expire:
    description: 'JWT inactivity expiration time'
    required: false
    default: '10m'
  client-url:
    description: 'Client URL'
    required: true
  api-url:
    description: 'API URL'
    required: true
  react-app-api-url:
    description: 'React app API URL'
    required: false
    default: ''

outputs:
  env-file:
    description: 'Path to generated .env file'
    value: ${{ inputs.output-file }}

runs:
  using: 'composite'
  steps:
    - name: Generate .env file
      shell: bash
      run: |
        echo "ğŸ“ Generating .env file for ${{ inputs.environment }} environment..."
        
        cat > ${{ inputs.output-file }} << EOF
        # Generated by GitHub Actions - ${{ inputs.environment }}
        # Date: $(date '+%Y-%m-%d %H:%M:%S')
        
        # Environment
        NODE_ENV=${{ inputs.environment }}
        
        # Database Configuration
        MYSQL_ROOT_PASSWORD=${{ inputs.mysql-root-password }}
        MYSQL_DATABASE=${{ inputs.mysql-database }}
        DB_HOST=${{ inputs.db-host }}
        DB_USER=${{ inputs.db-user }}
        DB_PASSWORD=${{ inputs.db-password }}
        DB_SYNC_ALTER=${{ inputs.db-sync-alter }}
        
        # JWT Configuration
        JWT_SECRET=${{ inputs.jwt-secret }}
        JWT_EXPIRE=${{ inputs.jwt-expire }}
        JWT_INACTIVITY_EXPIRE=${{ inputs.jwt-inactivity-expire }}
        
        # URLs
        CLIENT_URL=${{ inputs.client-url }}
        API_URL=${{ inputs.api-url }}
        EOF
        
        # Add REACT_APP_API_URL only if provided
        if [ -n "${{ inputs.react-app-api-url }}" ]; then
          echo "REACT_APP_API_URL=${{ inputs.react-app-api-url }}" >> ${{ inputs.output-file }}
        fi
        
        echo "âœ… Environment file generated: ${{ inputs.output-file }}"
    
    - name: Verify .env file
      shell: bash
      run: |
        echo "ğŸ” Verifying generated .env file..."
        if [ -f "${{ inputs.output-file }}" ]; then
          echo "âœ… File exists"
          echo "ğŸ“Š File size: $(du -h ${{ inputs.output-file }} | cut -f1)"
          echo "ğŸ“„ Variables count: $(grep -c "=" ${{ inputs.output-file }})"
        else
          echo "âŒ File not found!"
          exit 1
        fi
