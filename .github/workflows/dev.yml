name: Dev - Build, Test and Local Deploy

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    defaults:
      run:
        shell: powershell
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Stop existing containers
        run: |
          Write-Host "üõë Stopping existing containers..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml down 2>$null
          Write-Host "Containers stopped (if any were running)"
          
      - name: Build with dev environment
        run: |
          Write-Host "üöÄ Building with dev environment..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml build --no-cache
          
      - name: Start services
        run: |
          Write-Host "üé¨ Starting services..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml up -d
          
      - name: Wait for services
        run: |
          Write-Host "‚è≥ Waiting for services to start..."
          Start-Sleep -Seconds 30
          
      - name: Health check
        run: |
          Write-Host "üîç Checking service health..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml ps
          
      - name: Run tests
        run: |
          Write-Host "üß™ Running tests..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml exec -T backend npm test 2>$null
          Write-Host "Tests completed"
          
      - name: Deployment success
        run: |
          Write-Host "‚úÖ D√©ploiement DEV local r√©ussi!"
          Write-Host ""
          Write-Host "üåê URLs d'acc√®s sur votre machine:"
          Write-Host "  Frontend: http://localhost:3000"
          Write-Host "  Backend:  http://localhost:5001"
          Write-Host "  API:      http://localhost:5001/api"
          Write-Host ""
          Write-Host "üìä Services actifs:"
          docker compose --env-file .env.dev -f docker-compose.dev.yml ps
