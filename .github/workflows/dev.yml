name: Dev - Build, Test and Local Deploy

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    defaults:
      run:
        shell: powershell
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Clean up any existing containers
        run: |
          Write-Host "ğŸ§¹ Cleaning up existing containers and networks..."
          docker container prune -f
          docker network prune -f
      
      - name: Stop existing containers
        run: |
          Write-Host "ğŸ›‘ Stopping existing containers..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml down
          Write-Host "Containers stopped (if any were running)"
          
      - name: Build with dev environment
        run: |
          Write-Host "ğŸš€ Building with dev environment..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml build --no-cache
          
      - name: Start services
        run: |
          Write-Host "ğŸ¬ Starting services..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml up -d
          
      - name: Wait for services
        run: |
          Write-Host "â³ Waiting for services to start..."
          Start-Sleep -Seconds 30
          
      - name: Health check
        run: |
          Write-Host "ğŸ” Checking service health..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml ps
          
      - name: Run tests
        run: |
          Write-Host "ğŸ§ª Running tests..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml exec -T backend npm test
          Write-Host "Tests completed"
          
      - name: Deployment success
        run: |
          Write-Host "âœ… DÃ©ploiement DEV local rÃ©ussi!"
          Write-Host ""
          Write-Host "ğŸŒ URLs d'accÃ¨s sur votre machine:"
          Write-Host "  Frontend: http://localhost:3000"
          Write-Host "  Backend:  http://localhost:5001"
          Write-Host "  API:      http://localhost:5001/api"
          Write-Host ""
          Write-Host "ğŸ“Š Services actifs:"
          docker compose --env-file .env.dev -f docker-compose.dev.yml ps
