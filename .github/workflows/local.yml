name: Dev - Build, Test and Local Deploy

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env.dev from secrets (Windows)
        uses: ./.github/actions/generate-env
        with:
          environment: 'development'
          output-file: '.env.dev'
          mysql-root-password: ${{ secrets.DEV_MYSQL_ROOT_PASSWORD }}
          mysql-database: 'synergy'
          db-host: 'database'
          db-user: 'root'
          db-password: ${{ secrets.DEV_DB_PASSWORD }}
          db-sync-alter: 'true'
          jwt-secret: ${{ secrets.DEV_JWT_SECRET }}
          jwt-expire: '24h'
          jwt-inactivity-expire: '10m'
          client-url: 'http://localhost:3000'
          api-url: 'http://localhost:5001/api'
          react-app-api-url: 'http://localhost:5001/api'

      - name: Add development-specific variables
        shell: powershell
        run: |
          Write-Host "Adding development-specific variables..."
          @"
          TAG=dev
          DB_PORT=3306
          SERVER_PORT=5001
          CLIENT_PORT=3000
          "@ | Out-File -FilePath ".env.dev" -Append -Encoding UTF8
          Write-Host ".env.dev configured successfully"

      - name: Clean up any existing containers (Windows)
        shell: powershell
        run: |
          Write-Host "Cleaning up existing containers and networks..."
          docker container prune -f
          docker network prune -f

      - name: Stop existing containers (Windows)
        shell: powershell
        run: |
          Write-Host "Stopping existing containers..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml down
          Write-Host "Containers stopped (if any were running)"

      - name: Build with dev environment (Windows)
        shell: powershell
        run: |
          Write-Host "Building with dev environment..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml build

      - name: Start services (Windows)
        shell: powershell
        run: |
          Write-Host "Starting services..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml up -d

      - name: Wait for services (Windows)
        shell: powershell
        run: |
          Write-Host "Waiting for services to start..."
          Start-Sleep -Seconds 30

      - name: Run backend tests (Windows)
        shell: powershell
        run: |
          Write-Host "Running backend tests..."
          Write-Host "Executing unit tests..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml exec -T backend npm run test:unit
          Write-Host "Executing integration tests..."
          docker compose --env-file .env.dev -f docker-compose.dev.yml exec -T backend npm run test:integration
          Write-Host "All backend tests completed successfully!"

      - name: Deployment success (Windows)
        shell: powershell
        run: |
          Write-Host "==================================="
          Write-Host "Déploiement DEV local réussi!"
          Write-Host ""
          Write-Host "URLs d'accès sur votre machine:"
          Write-Host "  Frontend: http://localhost:3000"
          Write-Host "  Backend:  http://localhost:5001"
          Write-Host "  API:      http://localhost:5001/api"
          Write-Host ""
          Write-Host "Services actifs:"
          docker compose --env-file .env.dev -f docker-compose.dev.yml ps