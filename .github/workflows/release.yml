name: Release Bundle Generation

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  build-and-bundle:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Generate frontend .env
        run: echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > client/.env

      - name: Generate backend .env
        run: |
          cat > server/.env << EOF
          NODE_ENV=${{ secrets.NODE_ENV }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_SYNC_ALTER=${{ secrets.DB_SYNC_ALTER }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRE=${{ secrets.JWT_EXPIRE }}
          JWT_INACTIVITY_EXPIRE=${{ secrets.JWT_INACTIVITY_EXPIRE }}
          CLIENT_URL=${{ secrets.CLIENT_URL }}
          API_URL=${{ secrets.API_URL }}
          EOF

      - name: Clean Docker Buildx cache
        run: docker builder prune -af

      - name: Get version from package.json or create one
        id: version
        run: |
          if [ -f "./client/package.json" ]; then
            VERSION=$(grep '"version"' ./client/package.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
          else
            VERSION="1.0.$(date +%Y%m%d%H%M)"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version détectée: $VERSION"

      - name: Build Docker images
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "Building frontend..."
          docker buildx build \
            --load \
            --cache-from=type=gha,scope=frontend \
            --cache-to=type=gha,mode=max,scope=frontend \
            --tag synergia-frontend:$VERSION \
            --tag synergia-frontend:latest \
            ./client
          
          echo "Building backend..."
          docker buildx build \
            --load \
            --cache-from=type=gha,scope=backend \
            --cache-to=type=gha,mode=max,scope=backend \
            --tag synergia-backend:$VERSION \
            --tag synergia-backend:latest \
            ./server

      - name: Export Docker images in single tar
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p release/images
          
          echo "Pulling external images..."
          docker pull mysql:8.0
          docker pull nginx:alpine
          
          echo "Exporting all images to single tar..."
          docker save \
            synergia-frontend:$VERSION \
            synergia-backend:$VERSION \
            mysql:8.0 \
            nginx:alpine \
            -o release/images/all-images.tar
          
          echo "Export complete: $(du -h release/images/all-images.tar | cut -f1)"

      - name: Prepare release files
        run: |
          echo "Preparing release files..."
          VERSION="${{ steps.version.outputs.version }}"

          # Copier et adapter le docker-compose.prod.yml
          cp docker-compose.prod.yml release/docker-compose.yaml
          
          # S'assurer que les images pointent vers les bonnes versions
          sed -i "s/synergia-frontend:latest/synergia-frontend:$VERSION/g" release/docker-compose.yaml
          sed -i "s/synergia-backend:latest/synergia-backend:$VERSION/g" release/docker-compose.yaml
          
          # Créer .env.example basé sur les secrets et les noms de variables
          cat > release/.env.example << EOF
          # Configuration de la base de données MySQL
          MYSQL_ROOT_PASSWORD=CHANGEME_STRONG_PASSWORD
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          
          # Configuration du backend
          NODE_ENV=production
          DB_HOST=database
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=CHANGEME_STRONG_PASSWORD
          DB_SYNC_ALTER=false
          
          # Configuration JWT
          JWT_SECRET=CHANGEME_VERY_STRONG_SECRET_KEY
          JWT_EXPIRE=${{ secrets.JWT_EXPIRE }}
          JWT_INACTIVITY_EXPIRE=${{ secrets.JWT_INACTIVITY_EXPIRE }}
          
          # URLs (avec HTTPS via Nginx)
          CLIENT_URL=${{ secrets.CLIENT_URL }}
          API_URL=${{ secrets.API_URL }}
          REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}
          EOF

          # Copier les scripts existants
          cp deploy.sh release/
          cp rollback.sh release/
          cp validate-bundle.sh release/


          # S'assurer que les scripts sont exécutables
          chmod +x release/deploy.sh release/rollback.sh release/validate-bundle.sh

      - name: Generate release notes and checksums
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Release notes
          cat > release/release-notes.txt << EOF
          Synergia Release v$VERSION
          ==========================

          Date de build: $(date '+%Y-%m-%d %H:%M:%S')
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}

          ## Contenu de cette release

          - Frontend image: synergia-frontend:$VERSION
          - Backend image: synergia-backend:$VERSION
          - MySQL image: mysql:8.0
          - Nginx image: nginx:alpine (pour HTTPS)
          - Configuration: docker-compose.yaml + .env.example
          - Scripts: deploy.sh, rollback.sh, validate-bundle.sh

          ## Instructions de déploiement

          1. Validation: ./validate-bundle.sh
          2. Extraction: tar -xzf synergia-release-v$VERSION.tar.gz
          3. Déploiement: ./deploy.sh
             (Le script vous demandera de configurer les variables d'environnement)

          ## Rollback

          En cas de problème: ./rollback.sh

          ## Support

          - Vérifier les logs: docker compose logs
          - Statut des services: docker compose ps
          EOF

          # Génération des checksums
          echo "Génération des checksums..."
          cd release
          find . -type f -not -name "checksums.txt" -exec sha256sum {} \; | sort > checksums.txt

      - name: Create release archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCHIVE_NAME="synergia-release-v$VERSION.tar.gz"

          echo "Création de l'archive: $ARCHIVE_NAME"
          tar -czf "$ARCHIVE_NAME" -C release .

          echo "Archive créée: $(ls -lh "$ARCHIVE_NAME")"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: synergia-release-v${{ steps.version.outputs.version }}
          path: synergia-release-v${{ steps.version.outputs.version }}.tar.gz
          retention-days: 90

      - name: Release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Release v$VERSION générée avec succès!"
          echo "Archive: synergia-release-v$VERSION.tar.gz"
          echo "Taille: $(du -h synergia-release-v$VERSION.tar.gz | cut -f1)"