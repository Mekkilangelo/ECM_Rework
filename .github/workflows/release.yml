name: Release Bundle Generation

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  push:
    branches: [ main ]

jobs:
  build-and-bundle:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Generate frontend .env
        run: echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > client/.env

      - name: Generate backend .env
        uses: ./.github/actions/generate-env
        with:
          environment: ${{ secrets.NODE_ENV }}
          output-file: server/.env
          mysql-root-password: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          mysql-database: ${{ secrets.MYSQL_DATABASE }}
          db-host: ${{ secrets.DB_HOST }}
          db-user: ${{ secrets.DB_USER }}
          db-password: ${{ secrets.DB_PASSWORD }}
          db-sync-alter: ${{ secrets.DB_SYNC_ALTER }}
          jwt-secret: ${{ secrets.JWT_SECRET }}
          jwt-expire: ${{ secrets.JWT_EXPIRE }}
          jwt-inactivity-expire: ${{ secrets.JWT_INACTIVITY_EXPIRE }}
          client-url: ${{ secrets.CLIENT_URL }}
          api-url: ${{ secrets.API_URL }}

      - name: Clean Docker Buildx cache
        run: docker builder prune -af

      - name: Get version from package.json or create one
        id: version
        run: |
          if [ -f "./client/package.json" ]; then
            VERSION=$(grep '"version"' ./client/package.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
          else
            VERSION="1.0.$(date +%Y%m%d%H%M)"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version détectée: $VERSION"

      - name: Build Docker images
        uses: ./.github/actions/build-images
        with:
          version: ${{ steps.version.outputs.version }}

      - name: Export Docker images (including MySQL and Nginx)
        uses: ./.github/actions/export-images
        with:
          version: ${{ steps.version.outputs.version }}
          output-dir: release/images
          include-mysql: 'true'
          include-nginx: 'true'

      - name: Prepare release files
        run: |
          echo "Preparing release files..."
          VERSION="${{ steps.version.outputs.version }}"

          # Copier et adapter le docker-compose.prod.yml
          cp docker-compose.prod.yml release/docker-compose.yaml
          
          # S'assurer que les images pointent vers les bonnes versions
          sed -i "s/synergia-frontend:latest/synergia-frontend:$VERSION/g" release/docker-compose.yaml
          sed -i "s/synergia-backend:latest/synergia-backend:$VERSION/g" release/docker-compose.yaml
          
          # Créer .env.example basé sur les secrets et les noms de variables
          cat > release/.env.example << EOF
          # Configuration de la base de données MySQL
          MYSQL_ROOT_PASSWORD=CHANGEME_STRONG_PASSWORD
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          
          # Configuration du backend
          NODE_ENV=production
          DB_HOST=database
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=CHANGEME_STRONG_PASSWORD
          DB_SYNC_ALTER=false
          
          # Configuration JWT
          JWT_SECRET=CHANGEME_VERY_STRONG_SECRET_KEY
          JWT_EXPIRE=${{ secrets.JWT_EXPIRE }}
          JWT_INACTIVITY_EXPIRE=${{ secrets.JWT_INACTIVITY_EXPIRE }}
          
          # URLs (avec HTTPS via Nginx)
          CLIENT_URL=${{ secrets.CLIENT_URL }}
          API_URL=${{ secrets.API_URL }}
          REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}
          EOF

          # Copier les scripts existants
          cp deploy.sh release/
          cp rollback.sh release/
          cp validate-bundle.sh release/


          # S'assurer que les scripts sont exécutables
          chmod +x release/deploy.sh release/rollback.sh release/validate-bundle.sh

      - name: Generate release notes and checksums
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Release notes
          cat > release/release-notes.txt << EOF
          Synergia Release v$VERSION
          ==========================

          Date de build: $(date '+%Y-%m-%d %H:%M:%S')
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}

          ## Contenu de cette release

          - Frontend image: synergia-frontend:$VERSION
          - Backend image: synergia-backend:$VERSION
          - MySQL image: mysql:8.0
          - Nginx image: nginx:alpine (pour HTTPS)
          - Configuration: docker-compose.yaml + .env.example
          - Scripts: deploy.sh, rollback.sh, validate-bundle.sh

          ## Instructions de déploiement

          1. Validation: ./validate-bundle.sh
          2. Extraction: tar -xzf synergia-release-v$VERSION.tar.gz
          3. Déploiement: ./deploy.sh
             (Le script vous demandera de configurer les variables d'environnement)

          ## Rollback

          En cas de problème: ./rollback.sh

          ## Support

          - Vérifier les logs: docker compose logs
          - Statut des services: docker compose ps
          EOF

          # Génération des checksums
          echo "Génération des checksums..."
          cd release
          find . -type f -not -name "checksums.txt" -exec sha256sum {} \; | sort > checksums.txt

      - name: Create release archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCHIVE_NAME="synergia-release-v$VERSION.tar.gz"

          echo "Création de l'archive: $ARCHIVE_NAME"
          tar -czf "$ARCHIVE_NAME" -C release .

          echo "Archive créée: $(ls -lh "$ARCHIVE_NAME")"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: synergia-release-v${{ steps.version.outputs.version }}
          path: synergia-release-v${{ steps.version.outputs.version }}.tar.gz
          retention-days: 90

      - name: Release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Release v$VERSION générée avec succès!"
          echo "Archive: synergia-release-v$VERSION.tar.gz"
          echo "Taille: $(du -h synergia-release-v$VERSION.tar.gz | cut -f1)"